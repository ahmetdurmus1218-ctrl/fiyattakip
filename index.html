<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#3f51b5" />
  <title>FiyatTakip</title>

  <!-- Manifest -->
  <link rel="manifest" href="manifest.json" />

  <!-- iOS basit ikon -->
  <link rel="apple-touch-icon" href="icons/icon-192.png" />

  <style>
    :root{
      --primary:#3f51b5;
      --bg:#f3f5fb;
      --card:#ffffff;
      --muted:#6b7280;
      --shadow:0 10px 25px rgba(0,0,0,.08);
      --radius:18px;
      --max:720px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    body{ margin:0; background:var(--bg); color:#111827; }
    header{
      background: #ffffff;
      box-shadow: 0 2px 16px rgba(0,0,0,.06);
      position: sticky; top:0; z-index:10;
    }
    .topbar{
      max-width:var(--max);
      margin:0 auto;
      padding:14px 16px;
      display:flex; align-items:center; gap:12px;
    }
    .pill{
      background:#eef2ff;
      color:#1f2a7a;
      padding:6px 12px;
      border-radius:999px;
      font-weight:700;
      letter-spacing:.2px;
    }
    .menuBtn{
      margin-left:auto;
      border:none;
      background:#f3f4f6;
      border-radius:12px;
      padding:10px 12px;
      font-size:18px;
      cursor:pointer;
    }
    main{ max-width:var(--max); margin:0 auto; padding:16px; }
    h1{ margin:12px 0 6px; font-size:32px; }
    .sub{ margin:0 0 14px; color:var(--muted); }

    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
      margin:14px 0;
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    input, select, button, textarea{
      font:inherit;
      border-radius:14px;
      border:1px solid #e5e7eb;
      padding:12px 12px;
      outline:none;
      background:#fff;
    }
    input:focus, textarea:focus, select:focus{
      border-color:#c7d2fe;
      box-shadow:0 0 0 4px rgba(99,102,241,.12);
    }
    .q{ flex:1 1 240px; }
    .btn{
      background:var(--primary);
      color:#fff;
      border:none;
      padding:12px 16px;
      border-radius:16px;
      cursor:pointer;
      font-weight:700;
    }
    .btn:active{ transform: translateY(1px); }
    .btnGhost{
      background:#eef2ff;
      color:#1f2a7a;
      border:1px solid #dbeafe;
      border-radius:16px;
      cursor:pointer;
      font-weight:700;
    }
    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width:640px){ .grid2{ grid-template-columns:1fr; } }

    .siteList{ display:flex; gap:10px; flex-wrap:wrap; }
    .chip{
      padding:8px 10px;
      border-radius:999px;
      background:#f3f4f6;
      cursor:pointer;
      user-select:none;
      border:1px solid #e5e7eb;
      font-weight:600;
    }
    .chip.active{
      background:#eef2ff;
      border-color:#c7d2fe;
      color:#1f2a7a;
    }

    .muted{ color:var(--muted); font-size:13px; }
    .hr{ height:1px; background:#eef2f7; margin:12px 0; }

    .resultItem{
      border:1px solid #eef2f7;
      border-radius:16px;
      padding:12px;
      display:flex;
      align-items:flex-start;
      gap:10px;
      justify-content:space-between;
    }
    .resultLeft{ min-width:0; }
    .title{ font-weight:800; margin:0 0 6px; }
    .small{ margin:0; color:var(--muted); font-size:13px; }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .danger{ background:#fee2e2; color:#991b1b; border:1px solid #fecaca; }
    .ok{ background:#dcfce7; color:#166534; border:1px solid #bbf7d0; }

    /* simple drawer */
    .drawer{
      position:fixed; inset:0;
      background:rgba(0,0,0,.35);
      display:none;
      z-index:50;
    }
    .drawer.open{ display:block; }
    .panel{
      position:absolute; right:0; top:0; height:100%;
      width:min(360px, 92vw);
      background:#fff;
      padding:14px;
      box-shadow: -10px 0 25px rgba(0,0,0,.15);
    }
    .panel h3{ margin:4px 0 10px; }
    .panel .btn{ width:100%; }
    .panel .btnGhost{ width:100%; margin-top:8px; }
  </style>
</head>
<body>
<header>
  <div class="topbar">
    <span class="pill">fiyattakip</span>
    <button class="menuBtn" id="menuBtn">â˜°</button>
  </div>
</header>

<main>
  <h1>Fiyat KarÅŸÄ±laÅŸtÄ±r</h1>
  <p class="sub">ÃœrÃ¼n adÄ±nÄ± yaz, seÃ§tiÄŸin sitelerde arama aÃ§. Favoriye ekle, manuel fiyat dÃ¼ÅŸÃ¼ÅŸ uyarÄ±sÄ± kur.</p>

  <!-- SEARCH -->
  <div class="card">
    <div class="siteList" id="siteList"></div>

    <div class="row" style="margin-top:12px">
      <input class="q" id="q" placeholder="ÃœrÃ¼n adÄ±nÄ± yazÄ±n..." />
      <button class="btn" id="searchBtn">Ara</button>
    </div>
    <p class="muted" style="margin-top:10px">
      Not: Trendyol/Hepsiburada/N11/Amazon TR fiyatlarÄ±nÄ± tarayÄ±cÄ±dan otomatik Ã§ekmek (CORS + bot/captcha) yÃ¼zÃ¼nden direkt mÃ¼mkÃ¼n olmuyor.
      Bu sÃ¼rÃ¼m **arama aÃ§ar + favori + manuel fiyat takibi/bildirim** yapar.
    </p>
  </div>

  <!-- RESULTS -->
  <div class="card">
    <div class="row" style="align-items:center; justify-content:space-between">
      <div>
        <div style="font-weight:900">Arama sonuÃ§larÄ± (site bazlÄ±)</div>
        <div class="muted">Her satÄ±r seÃ§ili sitede arama aÃ§ar.</div>
      </div>
      <button class="btnGhost" id="clearResultsBtn">Temizle</button>
    </div>
    <div class="hr"></div>
    <div id="results"></div>
  </div>

  <!-- FAVORITES -->
  <div class="card">
    <div class="row" style="align-items:center; justify-content:space-between">
      <div>
        <div style="font-weight:900">â¤ï¸ Favoriler</div>
        <div class="muted">KaydettiÄŸin Ã¼rÃ¼nler burada.</div>
      </div>
      <button class="btnGhost danger" id="clearFavBtn">Favorileri Sil</button>
    </div>
    <div class="hr"></div>
    <div id="favorites"></div>
  </div>

  <!-- ALERTS -->
  <div class="card">
    <div style="font-weight:900">ğŸ”” Bildirimler (Manuel fiyat dÃ¼ÅŸÃ¼ÅŸ uyarÄ±sÄ±)</div>
    <p class="muted">
      ÃœrÃ¼n linkini yapÄ±ÅŸtÄ±r, â€œmevcut fiyatâ€ ve â€œhedef fiyatâ€ gir. Uygulama aÃ§Ä±ldÄ±ÄŸÄ±nda kontrol eder ve hedefin altÄ±ndaysa bildirim atar.
    </p>

    <div class="grid2">
      <input id="alertTitle" placeholder="ÃœrÃ¼n adÄ± (Ã¶rn: Xiaomi Pad 8)" />
      <input id="alertUrl" placeholder="ÃœrÃ¼n linki (Trendyol / HB / N11 / Amazon TR)" />
      <input id="alertCurrent" inputmode="decimal" placeholder="Mevcut fiyat (Ã¶rn: 12999)" />
      <input id="alertTarget" inputmode="decimal" placeholder="Hedef fiyat (Ã¶rn: 11999)" />
    </div>

    <div class="row" style="margin-top:10px">
      <button class="btn" id="addAlertBtn">UyarÄ± Ekle</button>
      <button class="btnGhost" id="checkAlertsBtn">Åimdi Kontrol Et</button>
      <button class="btnGhost" id="enableNotifBtn">Bildirim Ä°zni Ver</button>
    </div>

    <div class="hr"></div>
    <div id="alerts"></div>
  </div>
</main>

<!-- Drawer -->
<div class="drawer" id="drawer">
  <div class="panel">
    <h3>Ayarlar</h3>
    <p class="muted">PWA hazÄ±r. Buradan hÄ±zlÄ± iÅŸlemler.</p>
    <button class="btn" id="installBtn">UygulamayÄ± YÃ¼kle (Install)</button>
    <button class="btnGhost" id="exportBtn">Veriyi DÄ±ÅŸa Aktar (JSON)</button>
    <button class="btnGhost" id="importBtn">Veri Ä°Ã§e Aktar (JSON)</button>
    <input type="file" id="importFile" accept="application/json" style="display:none" />
    <div class="hr"></div>
    <button class="btnGhost danger" id="wipeBtn">TÃ¼m Veriyi SÄ±fÄ±rla</button>
    <div class="hr"></div>
    <button class="btnGhost" id="closeDrawerBtn">Kapat</button>
  </div>
</div>

<script>
/* ---------------------------
   STORAGE HELPERS
----------------------------*/
const LS = {
  get(key, fallback){
    try { return JSON.parse(localStorage.getItem(key)) ?? fallback; }
    catch { return fallback; }
  },
  set(key, val){
    localStorage.setItem(key, JSON.stringify(val));
  }
};

const KEY = {
  sites: "ft_sites",
  favs:  "ft_favorites",
  alerts:"ft_alerts"
};

const DEFAULT_SITES = [
  { id:"trendyol", name:"Trendyol",  url:(q)=>`https://www.trendyol.com/sr?q=${encodeURIComponent(q)}` },
  { id:"hb",      name:"Hepsiburada",url:(q)=>`https://www.hepsiburada.com/ara?q=${encodeURIComponent(q)}` },
  { id:"n11",     name:"N11",        url:(q)=>`https://www.n11.com/arama?q=${encodeURIComponent(q)}` },
  { id:"amazon",  name:"Amazon TR",  url:(q)=>`https://www.amazon.com.tr/s?k=${encodeURIComponent(q)}` }
];

/* ---------------------------
   UI ELEMENTS
----------------------------*/
const el = (id)=>document.getElementById(id);
const siteListEl = el("siteList");
const resultsEl  = el("results");
const favEl      = el("favorites");
const alertsEl   = el("alerts");

let selectedSites = LS.get(KEY.sites, DEFAULT_SITES.map(s=>s.id));
let favorites = LS.get(KEY.favs, []);
let alerts = LS.get(KEY.alerts, []);

/* ---------------------------
   SITES UI
----------------------------*/
function renderSites(){
  siteListEl.innerHTML = "";
  DEFAULT_SITES.forEach(s=>{
    const b = document.createElement("div");
    b.className = "chip" + (selectedSites.includes(s.id) ? " active" : "");
    b.textContent = s.name;
    b.onclick = ()=>{
      if(selectedSites.includes(s.id)){
        selectedSites = selectedSites.filter(x=>x!==s.id);
      } else {
        selectedSites.push(s.id);
      }
      if(selectedSites.length === 0){
        selectedSites = [s.id];
      }
      LS.set(KEY.sites, selectedSites);
      renderSites();
    };
    siteListEl.appendChild(b);
  });
}

/* ---------------------------
   SEARCH / RESULTS
----------------------------*/
function makeResultItems(query){
  const sites = DEFAULT_SITES.filter(s=>selectedSites.includes(s.id));
  return sites.map(s=>{
    const openUrl = s.url(query);
    return {
      id: crypto.randomUUID(),
      query,
      siteId: s.id,
      siteName: s.name,
      url: openUrl,
      createdAt: Date.now()
    };
  });
}

function renderResults(items){
  resultsEl.innerHTML = "";
  if(!items || items.length===0){
    resultsEl.innerHTML = `<p class="muted">HenÃ¼z arama yapÄ±lmadÄ±.</p>`;
    return;
  }
  items.forEach(item=>{
    const row = document.createElement("div");
    row.className = "resultItem";
    row.innerHTML = `
      <div class="resultLeft">
        <p class="title">${item.siteName}</p>
        <p class="small">Arama: <b>${escapeHtml(item.query)}</b></p>
      </div>
      <div class="actions">
        <button class="btnGhost ok" data-open>Siteyi AÃ§</button>
        <button class="btnGhost" data-fav>Favoriye Ekle</button>
      </div>
    `;
    row.querySelector("[data-open]").onclick = ()=> window.open(item.url, "_blank");
    row.querySelector("[data-fav]").onclick = ()=>{
      addFavorite({
        title: item.query,
        site: item.siteName,
        url: item.url
      });
    };
    resultsEl.appendChild(row);
  });
}

let currentResults = [];

el("searchBtn").onclick = ()=>{
  const q = el("q").value.trim();
  if(!q){ toast("ÃœrÃ¼n adÄ± yaz."); return; }
  currentResults = makeResultItems(q);
  renderResults(currentResults);
};

el("clearResultsBtn").onclick = ()=>{
  currentResults = [];
  renderResults(currentResults);
};

/* Enter ile ara */
el("q").addEventListener("keydown", (e)=>{
  if(e.key === "Enter") el("searchBtn").click();
});

/* ---------------------------
   FAVORITES
----------------------------*/
function addFavorite({title, site, url}){
  const exists = favorites.some(f=>f.url===url);
  if(exists){ toast("Zaten favorilerde."); return; }
  favorites.unshift({
    id: crypto.randomUUID(),
    title, site, url,
    createdAt: Date.now()
  });
  LS.set(KEY.favs, favorites);
  renderFavorites();
  toast("Favoriye eklendi âœ…");
}

function removeFavorite(id){
  favorites = favorites.filter(f=>f.id!==id);
  LS.set(KEY.favs, favorites);
  renderFavorites();
}

function renderFavorites(){
  favEl.innerHTML = "";
  if(favorites.length===0){
    favEl.innerHTML = `<p class="muted">Favori yok.</p>`;
    return;
  }
  favorites.forEach(f=>{
    const row = document.createElement("div");
    row.className = "resultItem";
    row.innerHTML = `
      <div class="resultLeft">
        <p class="title">${escapeHtml(f.title)}</p>
        <p class="small">${escapeHtml(f.site)}</p>
        <p class="small" style="word-break:break-all">${escapeHtml(f.url)}</p>
      </div>
      <div class="actions">
        <button class="btnGhost ok" data-open>AÃ§</button>
        <button class="btnGhost" data-alert>UyarÄ± Kur</button>
        <button class="btnGhost danger" data-del>Sil</button>
      </div>
    `;
    row.querySelector("[data-open]").onclick = ()=> window.open(f.url, "_blank");
    row.querySelector("[data-alert]").onclick = ()=>{
      el("alertTitle").value = f.title;
      el("alertUrl").value = f.url;
      toast("Link uyarÄ± formuna geldi. FiyatlarÄ± girip 'UyarÄ± Ekle' de.");
      window.scrollTo({top: document.body.scrollHeight, behavior:"smooth"});
    };
    row.querySelector("[data-del]").onclick = ()=> removeFavorite(f.id);
    favEl.appendChild(row);
  });
}

el("clearFavBtn").onclick = ()=>{
  if(!confirm("TÃ¼m favoriler silinsin mi?")) return;
  favorites = [];
  LS.set(KEY.favs, favorites);
  renderFavorites();
};

/* ---------------------------
   ALERTS (MANUAL)
----------------------------*/
function parsePrice(x){
  if(x==null) return null;
  const s = String(x).replace(",", ".").replace(/[^\d.]/g,"");
  const n = Number(s);
  return Number.isFinite(n) ? n : null;
}

function addAlert(){
  const title = el("alertTitle").value.trim();
  const url   = el("alertUrl").value.trim();
  const cur   = parsePrice(el("alertCurrent").value.trim());
  const tgt   = parsePrice(el("alertTarget").value.trim());

  if(!title || !url || cur==null || tgt==null){
    toast("ÃœrÃ¼n adÄ± + link + fiyatlar dolu olmalÄ±.");
    return;
  }

  alerts.unshift({
    id: crypto.randomUUID(),
    title, url,
    current: cur,
    target: tgt,
    createdAt: Date.now(),
    lastCheckedAt: 0,
    lastNotifiedAt: 0
  });
  LS.set(KEY.alerts, alerts);
  renderAlerts();
  toast("UyarÄ± eklendi ğŸ””");
}

function updateAlertPrice(id, newCurrent){
  alerts = alerts.map(a=> a.id===id ? {...a, current:newCurrent} : a);
  LS.set(KEY.alerts, alerts);
  renderAlerts();
}

function removeAlert(id){
  alerts = alerts.filter(a=>a.id!==id);
  LS.set(KEY.alerts, alerts);
  renderAlerts();
}

async function ensureNotificationPermission(){
  if(!("Notification" in window)) { toast("Bu cihaz bildirim desteklemiyor."); return false; }
  if(Notification.permission === "granted") return true;
  const p = await Notification.requestPermission();
  return p === "granted";
}

async function notify(title, body){
  const ok = await ensureNotificationPermission();
  if(!ok) { toast("Bildirim izni yok."); return; }
  try{
    new Notification(title, { body });
  }catch{
    // bazÄ± Android WebView'larda SW Ã¼zerinden olur, burada en azÄ±ndan toast:
    toast(body);
  }
}

function checkAlerts(manual=false){
  const now = Date.now();
  alerts = alerts.map(a=> ({...a, lastCheckedAt: now}));
  LS.set(KEY.alerts, alerts);

  // Hedefin altÄ±na dÃ¼ÅŸtÃ¼yse bildir
  alerts.forEach(a=>{
    if(a.current <= a.target){
      // spam olmasÄ±n: 1 saatte 1 kez
      if(now - (a.lastNotifiedAt||0) > 60*60*1000 || manual){
        a.lastNotifiedAt = now;
        notify("Fiyat dÃ¼ÅŸtÃ¼ âœ…", `${a.title} hedefin altÄ±nda: ${a.current} â‰¤ ${a.target}`);
      }
    }
  });

  LS.set(KEY.alerts, alerts);
  renderAlerts();
  toast("Kontrol yapÄ±ldÄ±.");
}

function renderAlerts(){
  alertsEl.innerHTML = "";
  if(alerts.length===0){
    alertsEl.innerHTML = `<p class="muted">UyarÄ± yok.</p>`;
    return;
  }

  alerts.forEach(a=>{
    const row = document.createElement("div");
    row.className = "resultItem";
    const status = (a.current <= a.target)
      ? `<span class="chip active">HEDEF ALTINDA âœ…</span>`
      : `<span class="chip">Bekliyor</span>`;

    row.innerHTML = `
      <div class="resultLeft">
        <p class="title">${escapeHtml(a.title)} ${status}</p>
        <p class="small" style="word-break:break-all">${escapeHtml(a.url)}</p>
        <p class="small">Mevcut: <b>${a.current}</b> â€¢ Hedef: <b>${a.target}</b></p>
        <p class="small muted">Son kontrol: ${a.lastCheckedAt ? new Date(a.lastCheckedAt).toLocaleString() : "-"}</p>
      </div>
      <div class="actions">
        <button class="btnGhost ok" data-open>AÃ§</button>
        <button class="btnGhost" data-update>Fiyat GÃ¼ncelle</button>
        <button class="btnGhost danger" data-del>Sil</button>
      </div>
    `;
    row.querySelector("[data-open]").onclick = ()=> window.open(a.url, "_blank");
    row.querySelector("[data-update]").onclick = ()=>{
      const v = prompt("Yeni mevcut fiyatÄ± yaz (sayÄ±):", String(a.current));
      if(v==null) return;
      const n = parsePrice(v);
      if(n==null) { toast("GeÃ§ersiz fiyat."); return; }
      updateAlertPrice(a.id, n);
      toast("Fiyat gÃ¼ncellendi.");
    };
    row.querySelector("[data-del]").onclick = ()=> removeAlert(a.id);
    alertsEl.appendChild(row);
  });
}

el("addAlertBtn").onclick = addAlert;
el("checkAlertsBtn").onclick = ()=>checkAlerts(true);
el("enableNotifBtn").onclick = ensureNotificationPermission;

/* Uygulama aÃ§Ä±ldÄ±ÄŸÄ±nda bir kez kontrol et */
window.addEventListener("load", ()=>{
  renderSites();
  renderResults(currentResults);
  renderFavorites();
  renderAlerts();
  // aÃ§Ä±lÄ±ÅŸta kontrol:
  setTimeout(()=>checkAlerts(false), 800);
});

/* ---------------------------
   INSTALL PROMPT
----------------------------*/
let deferredPrompt = null;
window.addEventListener("beforeinstallprompt", (e)=>{
  e.preventDefault();
  deferredPrompt = e;
});
el("installBtn").onclick = async ()=>{
  if(!deferredPrompt){ toast("Install tetiklenmedi. Chrome menÃ¼ > Ana ekrana ekle de olur."); return; }
  deferredPrompt.prompt();
  await deferredPrompt.userChoice;
  deferredPrompt = null;
};

/* ---------------------------
   DRAWER + EXPORT/IMPORT
----------------------------*/
const drawer = el("drawer");
el("menuBtn").onclick = ()=> drawer.classList.add("open");
el("closeDrawerBtn").onclick = ()=> drawer.classList.remove("open");
drawer.addEventListener("click", (e)=>{ if(e.target === drawer) drawer.classList.remove("open"); });

el("wipeBtn").onclick = ()=>{
  if(!confirm("TÃ¼m veriler (favori/uyarÄ±lar) sÄ±fÄ±rlansÄ±n mÄ±?")) return;
  favorites = []; alerts = [];
  LS.set(KEY.favs, favorites);
  LS.set(KEY.alerts, alerts);
  renderFavorites(); renderAlerts();
  toast("SÄ±fÄ±rlandÄ±.");
};

el("exportBtn").onclick = ()=>{
  const data = {
    sites: selectedSites,
    favorites,
    alerts,
    exportedAt: new Date().toISOString()
  };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "fiyattakip-data.json";
  a.click();
  URL.revokeObjectURL(url);
};

el("importBtn").onclick = ()=> el("importFile").click();
el("importFile").addEventListener("change", async (e)=>{
  const file = e.target.files?.[0];
  if(!file) return;
  const text = await file.text();
  try{
    const data = JSON.parse(text);
    if(Array.isArray(data.sites)) selectedSites = data.sites;
    if(Array.isArray(data.favorites)) favorites = data.favorites;
    if(Array.isArray(data.alerts)) alerts = data.alerts;
    LS.set(KEY.sites, selectedSites);
    LS.set(KEY.favs, favorites);
    LS.set(KEY.alerts, alerts);
    renderSites(); renderFavorites(); renderAlerts();
    toast("Ä°Ã§e aktarÄ±ldÄ± âœ…");
  }catch{
    toast("JSON okunamadÄ±.");
  }finally{
    e.target.value = "";
  }
});

/* ---------------------------
   SERVICE WORKER
----------------------------*/
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("sw.js").catch(()=>{});
}

/* ---------------------------
   UTILS
----------------------------*/
function toast(msg){
  const d = document.createElement("div");
  d.textContent = msg;
  d.style.position="fixed";
  d.style.left="50%";
  d.style.bottom="22px";
  d.style.transform="translateX(-50%)";
  d.style.background="#111827";
  d.style.color="#fff";
  d.style.padding="10px 14px";
  d.style.borderRadius="14px";
  d.style.boxShadow="0 10px 25px rgba(0,0,0,.25)";
  d.style.zIndex="9999";
  d.style.maxWidth="92vw";
  d.style.fontWeight="700";
  document.body.appendChild(d);
  setTimeout(()=>{ d.style.opacity="0"; d.style.transition="opacity .25s"; }, 1600);
  setTimeout(()=> d.remove(), 2000);
}
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}
</script>
</body>
</html>
