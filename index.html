<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FiyatTakip</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#3f51b5">

  <style>
    :root { --pri:#3f51b5; --bg:#f5f7ff; --card:#fff; --mut:#6b7280; --ok:#1f7a2a; --bad:#7a1f1f; }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:#111; }
    .wrap{ max-width:520px; margin:0 auto; padding:18px; }
    .top{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .brand{ display:inline-block; padding:8px 12px; background:#e9edff; border-radius:10px; font-weight:800; color:#25306a; }
    .menu{ font-size:24px; cursor:pointer; user-select:none; padding:6px 10px; border-radius:10px; }
    .menu:hover{ background:rgba(0,0,0,.05); }

    h1{ margin:14px 0 6px; font-size:34px; letter-spacing:-.5px; }
    .sub{ margin:0 0 16px; color:var(--mut); }

    .card{ background:var(--card); border-radius:16px; padding:14px; box-shadow:0 6px 20px rgba(25,40,80,.08); }
    input[type="text"], input[type="number"]{
      width:100%; padding:14px 14px; border-radius:14px; border:1px solid #dde3ff; outline:none; font-size:16px;
      background:#fff; box-sizing:border-box;
    }
    .btn{
      width:100%; margin-top:12px; padding:14px 16px; border:0; border-radius:14px; background:var(--pri);
      color:#fff; font-size:18px; font-weight:800; cursor:pointer;
    }
    .btn:active{ transform:scale(.99); }

    .hint{ margin:14px 0; background:#eef2ff; border-radius:14px; padding:12px 14px; color:#1f2a6b; }
    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:14px; }
    .tile{ background:#fff; border-radius:16px; padding:14px; text-align:center; cursor:pointer; box-shadow:0 6px 20px rgba(25,40,80,.08); }
    .tile span{ display:block; margin-top:8px; color:var(--mut); font-size:13px; }

    .modalBg{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:flex-end; }
    .modal{ width:100%; max-width:520px; margin:0 auto; background:#fff; border-radius:18px 18px 0 0; padding:14px; }
    .tabRow{ display:flex; gap:10px; margin:10px 0 12px; }
    .tab{ flex:1; padding:10px 12px; border-radius:12px; border:1px solid #e7e9ff; background:#fafbff; cursor:pointer; font-weight:800; }
    .tab.active{ background:#e9edff; border-color:#cfd6ff; color:#25306a; }
    .list{ display:flex; flex-direction:column; gap:10px; }
    .item{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; background:#fafbff; border:1px solid #edf0ff; border-radius:14px; padding:12px; }
    .item b{ display:block; }
    .item small{ color:var(--mut); }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .mini{ border:0; border-radius:12px; padding:10px 12px; cursor:pointer; font-weight:800; }
    .mini.open{ background:#e9edff; color:#25306a; }
    .mini.del{ background:#ffe9e9; color:var(--bad); }
    .mini.add{ background:#e9ffe9; color:var(--ok); }
    .mini.gray{ background:#f1f5f9; color:#0f172a; }

    .sites{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    .chip{ padding:8px 10px; border-radius:999px; border:1px solid #e7e9ff; background:#fafbff; cursor:pointer; font-weight:800; font-size:13px; }
    .chip.on{ background:#e9edff; border-color:#cfd6ff; color:#25306a; }

    .warn{ margin-top:10px; padding:10px 12px; border-radius:12px; background:#fff7ed; border:1px solid #fed7aa; color:#7c2d12; font-size:13px; }
    .ok{ margin-top:10px; padding:10px 12px; border-radius:12px; background:#ecfdf5; border:1px solid #bbf7d0; color:#065f46; font-size:13px; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">fiyattakip</div>
      <div class="menu" id="openMenu">â˜°</div>
    </div>

    <h1>Fiyat KarÅŸÄ±laÅŸtÄ±r</h1>
    <p class="sub">ÃœrÃ¼n adÄ±nÄ± yaz, farklÄ± sitelerde arat. Ä°stersen Ã¼rÃ¼n linkini kaydet.</p>

    <div class="card">
      <input id="q" type="text" placeholder="ÃœrÃ¼n adÄ±nÄ± yazÄ±n... (Ã¶rn: Redmi Note 13)" />
      <button class="btn" id="btnSearch">Ara</button>

      <div class="sites" id="siteChips"></div>

      <div class="warn">
        Otomatik fiyat Ã§ekme Ã§oÄŸu sitede engellenir (CORS/bot korumasÄ±). Bu sÃ¼rÃ¼mde â€œbildirimâ€ manuel fiyat gÃ¼ncelleme ile Ã§alÄ±ÅŸÄ±r.
      </div>
    </div>

    <div class="hint">
      <b>Ä°pucu</b><br/>
      â€œAraâ€ â†’ sonuÃ§ linkleri gelir â†’ â€œFavoriye Kaydetâ€ ile aramayÄ± kaydedebilirsin.<br/>
      â€œÃœrÃ¼n Linki Ekleâ€ ile tek Ã¼rÃ¼n sayfasÄ±nÄ± da favoriye ekleyebilirsin.
    </div>

    <div class="grid">
      <div class="tile" id="btnAddLink">ğŸ”—<div>ÃœrÃ¼n Linki Ekle</div><span>Tek Ã¼rÃ¼n linki kaydet</span></div>
      <div class="tile" id="btnFav">â¤ï¸<div>Favoriler</div><span>Aramalar + Ã¼rÃ¼n linkleri</span></div>
      <div class="tile" id="btnNoti">ğŸ””<div>Bildirimler</div><span>Fiyat dÃ¼ÅŸÃ¼ÅŸ uyarÄ±larÄ±</span></div>
      <div class="tile" id="btnHow">â„¹ï¸<div>NasÄ±l KullanÄ±lÄ±r</div><span>2 dakikada</span></div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modalBg" id="modalBg">
    <div class="modal">
      <div class="tabRow">
        <button class="tab active" id="tabResults">SonuÃ§</button>
        <button class="tab" id="tabFav">Favoriler</button>
        <button class="tab" id="tabNoti">Bildirimler</button>
        <button class="tab" id="tabAdd">ÃœrÃ¼n Linki</button>
      </div>

      <div id="resultsView"><div class="list" id="resultsList"></div></div>
      <div id="favView" style="display:none;"><div class="list" id="favList"></div></div>
      <div id="notiView" style="display:none;"><div class="list" id="notiList"></div></div>
      <div id="addView" style="display:none;">
        <div class="card" style="box-shadow:none; border:1px solid #edf0ff;">
          <div style="font-weight:900;margin-bottom:8px;">ÃœrÃ¼n linkini favoriye ekle</div>
          <input id="linkName" type="text" placeholder="ÃœrÃ¼n adÄ± (Ã¶rn: Xiaomi Pad 7)" />
          <input id="linkUrl" type="text" placeholder="ÃœrÃ¼n linki (Trendyol/HB/N11/Amazon)" style="margin-top:10px;" />
          <button class="btn" id="addLinkBtn">Favoriye Ekle</button>
          <div class="ok">Bunu ekleyince Favorilerâ€™den tek tÄ±k â€œAÃ§â€ ile Ã¼rÃ¼n sayfasÄ± aÃ§Ä±lÄ±r.</div>
        </div>
      </div>

      <div style="display:flex; gap:10px; margin-top:12px;">
        <button class="tab" id="closeModal" style="flex:1;">Kapat</button>
      </div>
    </div>
  </div>

<script>
  // --- Service Worker ---
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  }

  // --- Sites ---
  const SITES = [
    { key:"trendyol", name:"Trendyol", make:(q)=>`https://www.trendyol.com/sr?q=${encodeURIComponent(q)}` },
    { key:"hepsiburada", name:"Hepsiburada", make:(q)=>`https://www.hepsiburada.com/ara?q=${encodeURIComponent(q)}` },
    { key:"n11", name:"N11", make:(q)=>`https://www.n11.com/arama?q=${encodeURIComponent(q)}` },
    { key:"amazon", name:"Amazon TR", make:(q)=>`https://www.amazon.com.tr/s?k=${encodeURIComponent(q)}` },
  ];

  // --- Storage ---
  const LS = {
    favKey: "ft_favs_v2",
    notiKey:"ft_noti_v2",
    siteKey:"ft_sites_v2",
    load(k, def){ try{ return JSON.parse(localStorage.getItem(k)) ?? def }catch{ return def } },
    save(k, v){ localStorage.setItem(k, JSON.stringify(v)); }
  };

  // fav item types:
  // {id,type:"query", q, sites, createdAt}
  // {id,type:"link", name, url, createdAt}
  let selectedSites = LS.load(LS.siteKey, SITES.map(s=>s.key));
  let favs = LS.load(LS.favKey, []);
  // noti item:
  // {id, name, url, target, lastPrice, createdAt}
  let notis = LS.load(LS.notiKey, []);

  // --- Elements ---
  const qEl = document.getElementById("q");
  const siteChips = document.getElementById("siteChips");
  const modalBg = document.getElementById("modalBg");

  const resultsView = document.getElementById("resultsView");
  const favView = document.getElementById("favView");
  const notiView = document.getElementById("notiView");
  const addView = document.getElementById("addView");

  const resultsList = document.getElementById("resultsList");
  const favList = document.getElementById("favList");
  const notiList = document.getElementById("notiList");

  const tabResults = document.getElementById("tabResults");
  const tabFav = document.getElementById("tabFav");
  const tabNoti = document.getElementById("tabNoti");
  const tabAdd = document.getElementById("tabAdd");

  function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }
  function escapeHtml(str){ return String(str||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  // --- Chips ---
  function renderChips(){
    siteChips.innerHTML = "";
    SITES.forEach(s=>{
      const b = document.createElement("button");
      b.className = "chip " + (selectedSites.includes(s.key) ? "on" : "");
      b.textContent = s.name;
      b.onclick = ()=>{
        if (selectedSites.includes(s.key)) selectedSites = selectedSites.filter(x=>x!==s.key);
        else selectedSites = [...selectedSites, s.key];
        LS.save(LS.siteKey, selectedSites);
        renderChips();
      };
      siteChips.appendChild(b);
    });
  }
  renderChips();

  // --- Modal tabs ---
  function showTab(which){
    [tabResults, tabFav, tabNoti, tabAdd].forEach(t=>t.classList.remove("active"));
    resultsView.style.display="none";
    favView.style.display="none";
    notiView.style.display="none";
    addView.style.display="none";

    if(which==="results"){ tabResults.classList.add("active"); resultsView.style.display="block"; }
    if(which==="fav"){ tabFav.classList.add("active"); favView.style.display="block"; renderFavs(); }
    if(which==="noti"){ tabNoti.classList.add("active"); notiView.style.display="block"; renderNotis(); }
    if(which==="add"){ tabAdd.classList.add("active"); addView.style.display="block"; }
  }

  tabResults.onclick = ()=>showTab("results");
  tabFav.onclick = ()=>showTab("fav");
  tabNoti.onclick = ()=>showTab("noti");
  tabAdd.onclick = ()=>showTab("add");

  function openModal(which="results"){
    modalBg.style.display="flex";
    showTab(which);
  }

  document.getElementById("closeModal").onclick = ()=> modalBg.style.display="none";
  modalBg.addEventListener("click", (e)=>{ if(e.target===modalBg) modalBg.style.display="none"; });

  document.getElementById("openMenu").onclick = ()=>openModal("fav");
  document.getElementById("btnFav").onclick = ()=>openModal("fav");
  document.getElementById("btnNoti").onclick = ()=>openModal("noti");
  document.getElementById("btnAddLink").onclick = ()=>openModal("add");
  document.getElementById("btnHow").onclick = ()=>{
    openModal("results");
    resultsList.innerHTML = `
      <div class="hint">
        <b>KullanÄ±m</b><br/>
        1) ÃœrÃ¼n adÄ± yaz â†’ <b>Ara</b><br/>
        2) Gelen sitelerden <b>AÃ§</b> ile arama sayfalarÄ±nÄ± aÃ§<br/>
        3) <b>Favoriye Kaydet</b> ile aramayÄ± kaydet<br/>
        4) â€œÃœrÃ¼n Linkiâ€ sekmesinden tek Ã¼rÃ¼n linki kaydet<br/>
        5) Bildirimler: Ã¼rÃ¼n linki + hedef fiyat ekle, sonra â€œFiyat GÃ¼ncelleâ€ ile gÃ¼ncel fiyatÄ± yaz â†’ hedefe dÃ¼ÅŸerse bildirim verir.
      </div>
    `;
  };

  // --- Search & Results ---
  function doSearch(){
    const q = (qEl.value || "").trim();
    if(!q) return;

    const sites = selectedSites.length ? selectedSites : SITES.map(s=>s.key);
    const urls = SITES.filter(s=>sites.includes(s.key)).map(s=>({name:s.name, url:s.make(q)}));

    openModal("results");
    renderResults(q, urls, sites);
  }

  document.getElementById("btnSearch").onclick = doSearch;
  qEl.addEventListener("keydown", (e)=>{ if(e.key==="Enter") doSearch(); });

  function renderResults(q, urls, sites){
    resultsList.innerHTML = "";

    const box = document.createElement("div");
    box.className = "card";
    box.style.boxShadow = "none";
    box.style.border = "1px solid #edf0ff";
    box.innerHTML = `
      <div style="font-weight:900;margin-bottom:10px;">"${escapeHtml(q)}" sonuÃ§larÄ±</div>
      <div id="urlList" class="list"></div>
      <div style="height:10px"></div>
      <button class="mini add" id="addFavQuery">+ Bu aramayÄ± Favoriye Kaydet</button>
    `;
    resultsList.appendChild(box);

    const urlList = box.querySelector("#urlList");
    urls.forEach(u=>{
      const row = document.createElement("div");
      row.className = "item";
      row.innerHTML = `
        <div>
          <b>${escapeHtml(u.name)}</b>
          <small style="word-break:break-all;">${escapeHtml(u.url)}</small>
        </div>
        <div class="actions">
          <button class="mini open">AÃ§</button>
        </div>
      `;
      row.querySelector(".open").onclick = ()=> window.open(u.url, "_blank");
      urlList.appendChild(row);
    });

    box.querySelector("#addFavQuery").onclick = ()=>{
      favs.unshift({ id:uid(), type:"query", q, sites:[...sites], createdAt:Date.now() });
      LS.save(LS.favKey, favs);
      alert("Arama favoriye kaydedildi âœ…");
    };
  }

  // --- Add link to favorites ---
  document.getElementById("addLinkBtn").onclick = ()=>{
    const name = document.getElementById("linkName").value.trim();
    const url  = document.getElementById("linkUrl").value.trim();
    if(!url){ alert("Link zorunlu."); return; }
    favs.unshift({ id:uid(), type:"link", name: name || "ÃœrÃ¼n", url, createdAt:Date.now() });
    LS.save(LS.favKey, favs);
    document.getElementById("linkName").value="";
    document.getElementById("linkUrl").value="";
    alert("ÃœrÃ¼n linki favoriye eklendi âœ…");
    showTab("fav");
  };

  // --- Favorites list ---
  function renderFavs(){
    favList.innerHTML = "";

    if(!favs.length){
      favList.innerHTML = `<div class="hint">HenÃ¼z favori yok. Arama yapÄ±p kaydet veya Ã¼rÃ¼n linki ekle.</div>`;
      return;
    }

    favs.forEach(f=>{
      const row = document.createElement("div");
      row.className = "item";

      if(f.type==="query"){
        const sites = f.sites?.length ? f.sites : SITES.map(s=>s.key);
        const urls = SITES.filter(s=>sites.includes(s.key)).map(s=>({name:s.name, url:s.make(f.q)}));

        row.innerHTML = `
          <div>
            <b>ğŸ” ${escapeHtml(f.q)}</b>
            <small>Arama favorisi â€¢ ${new Date(f.createdAt).toLocaleString()}</small>
          </div>
          <div class="actions">
            <button class="mini open">AÃ§</button>
            <button class="mini gray">Bildirim Ekle</button>
            <button class="mini del">Sil</button>
          </div>
        `;

        row.querySelector(".open").onclick = ()=>{
          openModal("results");
          renderResults(f.q, urls, sites);
        };

        row.querySelector(".gray").onclick = ()=>{
          // query favoriden bildirim: kullanÄ±cÄ± Ã¼rÃ¼n linkini girmeli (Ã§Ã¼nkÃ¼ query ile fiyat takip olmaz)
          openModal("noti");
          alert("Arama favorisine otomatik takip olmaz. Bildirim iÃ§in Ã¼rÃ¼n linki ekleyerek uyarÄ± oluÅŸtur.");
        };

        row.querySelector(".del").onclick = ()=>{
          favs = favs.filter(x=>x.id!==f.id);
          LS.save(LS.favKey, favs);
          renderFavs();
        };
      } else {
        row.innerHTML = `
          <div>
            <b>ğŸ”— ${escapeHtml(f.name || "ÃœrÃ¼n")}</b>
            <small style="word-break:break-all;">${escapeHtml(f.url || "")}</small><br/>
            <small>ÃœrÃ¼n linki â€¢ ${new Date(f.createdAt).toLocaleString()}</small>
          </div>
          <div class="actions">
            <button class="mini open">AÃ§</button>
            <button class="mini add">Bildirim Ekle</button>
            <button class="mini del">Sil</button>
          </div>
        `;

        row.querySelector(".open").onclick = ()=> window.open(f.url, "_blank");

        row.querySelector(".add").onclick = ()=>{
          const target = prompt("Hedef fiyat (TL) yaz:");
          if(!target) return;
          const t = Number(String(target).replace(",", "."));
          if(!t || t<=0){ alert("Hedef fiyat geÃ§ersiz."); return; }

          notis.unshift({
            id: uid(),
            name: f.name || "ÃœrÃ¼n",
            url: f.url,
            target: t,
            lastPrice: null,
            createdAt: Date.now()
          });
          LS.save(LS.notiKey, notis);
          alert("Bildirim eklendi âœ… (Fiyat GÃ¼ncelle ile Ã§alÄ±ÅŸÄ±r)");
          openModal("noti");
        };

        row.querySelector(".del").onclick = ()=>{
          favs = favs.filter(x=>x.id!==f.id);
          LS.save(LS.favKey, favs);
          renderFavs();
        };
      }

      favList.appendChild(row);
    });
  }

  // --- Notifications ---
  async function ensureNotifyPermission(){
    if(!("Notification" in window)) return false;
    if(Notification.permission === "granted") return true;
    if(Notification.permission === "denied") return false;
    const p = await Notification.requestPermission();
    return p === "granted";
  }

  function renderNotis(){
    notiList.innerHTML = "";

    // add quick add card
    const addCard = document.createElement("div");
    addCard.className = "card";
    addCard.style.boxShadow="none";
    addCard.style.border="1px solid #edf0ff";
    addCard.innerHTML = `
      <div style="font-weight:900;margin-bottom:8px;">Yeni UyarÄ±</div>
      <input id="nName" type="text" placeholder="ÃœrÃ¼n adÄ± (Ã¶rn: Xiaomi Pad 7)" />
      <input id="nUrl" type="text" placeholder="ÃœrÃ¼n linki" style="margin-top:10px;" />
      <input id="nTarget" type="number" placeholder="Hedef fiyat (TL)" style="margin-top:10px;" />
      <button class="btn" id="addNotiBtn">UyarÄ± Ekle</button>
      <div class="warn">Sonra â€œFiyat GÃ¼ncelleâ€ deyip gÃ¼ncel fiyatÄ± girersin. Hedefe dÃ¼ÅŸerse bildirim verir.</div>
    `;
    notiList.appendChild(addCard);

    addCard.querySelector("#addNotiBtn").onclick = ()=>{
      const name = addCard.querySelector("#nName").value.trim() || "ÃœrÃ¼n";
      const url = addCard.querySelector("#nUrl").value.trim();
      const target = Number(addCard.querySelector("#nTarget").value);
      if(!url || !target){ alert("Link + hedef fiyat zorunlu."); return; }

      notis.unshift({ id:uid(), name, url, target, lastPrice:null, createdAt:Date.now() });
      LS.save(LS.notiKey, notis);
      renderNotis();
      alert("UyarÄ± eklendi âœ…");
    };

    if(!notis.length){
      const empty = document.createElement("div");
      empty.className="hint";
      empty.innerHTML = `HenÃ¼z uyarÄ± yok. Ãœstten ekle.`;
      notiList.appendChild(empty);
      return;
    }

    notis.forEach(n=>{
      const row = document.createElement("div");
      row.className = "item";
      row.innerHTML = `
        <div>
          <b>ğŸ”” ${escapeHtml(n.name || "ÃœrÃ¼n")}</b>
          <small>Hedef: ${Number(n.target||0).toLocaleString("tr-TR")} TL</small><br/>
          <small>Son fiyat: ${n.lastPrice ? Number(n.lastPrice).toLocaleString("tr-TR")+" TL" : "â€”"}</small><br/>
          <small style="word-break:break-all;">${escapeHtml(n.url||"")}</small>
        </div>
        <div class="actions">
          <button class="mini open">AÃ§</button>
          <button class="mini gray">Fiyat GÃ¼ncelle</button>
          <button class="mini del">Sil</button>
        </div>
      `;

      row.querySelector(".open").onclick = ()=> window.open(n.url, "_blank");

      row.querySelector(".gray").onclick = async ()=>{
        const ok = await ensureNotifyPermission();
        if(!ok){ alert("Bildirim izni verilmedi."); return; }

        const current = prompt("GÃ¼ncel fiyatÄ± TL olarak yaz (siteye bakÄ±p gir):", n.lastPrice ?? "");
        if(!current) return;
        const cur = Number(String(current).replace(",", "."));
        if(!cur || cur<=0){ alert("Fiyat geÃ§ersiz."); return; }

        n.lastPrice = cur;
        LS.save(LS.notiKey, notis);

        if(cur <= Number(n.target)){
          new Notification("Fiyat DÃ¼ÅŸtÃ¼ âœ…", { body: `${n.name}: ${cur} TL (hedef ${n.target} TL)` });
          // istersen direkt aÃ§sÄ±n
          // window.open(n.url, "_blank");
        } else {
          alert(`HenÃ¼z dÃ¼ÅŸmedi: ${cur} TL (hedef ${n.target} TL)`);
        }
        renderNotis();
      };

      row.querySelector(".del").onclick = ()=>{
        notis = notis.filter(x=>x.id!==n.id);
        LS.save(LS.notiKey, notis);
        renderNotis();
      };

      notiList.appendChild(row);
    });
  }
</script>
</body>
</html>
